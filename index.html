<!DOCTYPE html>
<html>
<head>
  <title>Chat Test</title>
  <style>
    body { margin: 0; padding-bottom: 3rem; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; }
    #form { background: rgba(0, 0, 0, 0.15); padding: 0.25rem; position: fixed; bottom: 0; left: 0; right: 0; display: flex; height: 3rem; box-sizing: border-box; backdrop-filter: blur(10px); }
    #input { border: none; padding: 0 1rem; flex-grow: 1; border-radius: 2rem; margin: 0.25rem; }
    #input:focus { outline: none; }
    #form > button { background: #333; border: none; padding: 0 1rem; margin: 0.25rem; border-radius: 3px; outline: none; color: #fff; }
    #messages { list-style-type: none; margin: 0; padding: 0; }
    #messages > li { padding: 0.5rem 1rem; }
    #messages > li:nth-child(odd) { background: #efefef; }
  </style>
</head>
<body>
  <ul id="messages"></ul>
  <form id="form" action="">
    <input id="input" autocomplete="off" /><button>Gửi</button>
  </form>

  <script src="/socket.io/socket.io.js"></script>

  <script>
    // Kết nối đến server
    const socket = io("https://chat.viegrand.site", {
      transports: ['websocket', 'polling'],
      upgrade: true,
      rememberUpgrade: true,
      timeout: 20000
    });
    
    // Đăng ký với số điện thoại 0000000003
    const userPhone = "0000000003";
    
    console.log("🔗 Kết nối socket với số điện thoại:", userPhone);
    
    // Đăng ký với server ngay khi script load
    console.log("📞 Đăng ký với số điện thoại:", userPhone);
    socket.emit('register', userPhone);
    
    // Heartbeat để giữ kết nối
    setInterval(() => {
      if (socket.connected) {
        socket.emit('heartbeat', { phone: userPhone, timestamp: Date.now() });
        console.log("💓 Heartbeat sent");
      }
    }, 30000); // Gửi heartbeat mỗi 30 giây
    
    // Lấy các element từ HTML
    const form = document.getElementById('form');
    const input = document.getElementById('input');
    const messages = document.getElementById('messages');
    
    // Hiển thị thông tin kết nối
    const statusDiv = document.createElement('div');
    statusDiv.innerHTML = `<h3>📱 Người dùng: ${userPhone}</h3><p>🟢 Đã kết nối socket</p>`;
    statusDiv.style.cssText = 'background: #e8f5e8; padding: 10px; margin: 10px; border-radius: 5px;';
    document.body.insertBefore(statusDiv, messages);

    // Khi form được gửi đi
    form.addEventListener('submit', function(e) {
      e.preventDefault();
      if (input.value) {
        // Gửi tin nhắn test
        const messageData = {
          sender: userPhone,
          message: input.value,
          timestamp: new Date().toLocaleTimeString()
        };
        
        console.log('📤 Web sending message:', messageData);
        socket.emit('chat message', messageData);
        input.value = '';
      }
    });

    // Lắng nghe tin nhắn từ app
    socket.on('chat message', function(data) {
      console.log("📨 Nhận tin nhắn:", data);
      console.log("📨 Kiểu dữ liệu:", typeof data);
      console.log("📨 Chi tiết:", JSON.stringify(data, null, 2));
      
      const item = document.createElement('li');
      item.style.cssText = 'background: #f0f8ff; padding: 10px; margin: 5px 0; border-radius: 5px; border-left: 4px solid #007bff;';
      
      if (typeof data === 'string') {
        // Tin nhắn đơn giản
        item.textContent = `📨 ${data}`;
      } else {
        // Tin nhắn có cấu trúc
        const sender = data.sender || data.senderPhone || 'Unknown';
        const message = data.message || data.messageText || data.message_text || data;
        const time = data.timestamp || data.sent_at || new Date().toLocaleTimeString();
        
        item.innerHTML = `
          <div><strong>👤 ${sender}</strong></div>
          <div>💬 ${message}</div>
          <div style="font-size: 12px; color: #666;">⏰ ${time}</div>
        `;
      }
      
      messages.appendChild(item);
      window.scrollTo(0, document.body.scrollHeight);
    });
    
    // Lắng nghe notification
    socket.on('notification', function(data) {
      console.log("🔔 Nhận notification:", data);
      
      const item = document.createElement('li');
      item.style.cssText = 'background: #fff3cd; padding: 10px; margin: 5px 0; border-radius: 5px; border-left: 4px solid #ffc107;';
      item.innerHTML = `
        <div><strong>🔔 Notification</strong></div>
        <div>${JSON.stringify(data, null, 2)}</div>
      `;
      
      messages.appendChild(item);
      window.scrollTo(0, document.body.scrollHeight);
    });
    
    // Hiển thị trạng thái kết nối
    socket.on('connect', function() {
      console.log("✅ Đã kết nối socket với ID:", socket.id);
      statusDiv.innerHTML = `<h3>📱 Người dùng: ${userPhone}</h3><p>🟢 Đã kết nối socket (ID: ${socket.id})</p>`;
      
      // Đăng ký lại sau khi kết nối
      socket.emit('register', userPhone);
      console.log("📞 Đăng ký lại với số điện thoại:", userPhone);
      
      // Log connection state
      console.log("🔍 Socket connected:", socket.connected);
      console.log("🔍 Socket id:", socket.id);
    });

    socket.on('connect_error', function(error) {
      console.log("❌ Lỗi kết nối socket:", error);
      statusDiv.innerHTML = `<h3>📱 Người dùng: ${userPhone}</h3><p>🔴 Lỗi kết nối: ${error.message}</p>`;
    });

    socket.on('disconnect', function(reason) {
      console.log("🔌 Ngắt kết nối socket:", reason);
      statusDiv.innerHTML = `<h3>📱 Người dùng: ${userPhone}</h3><p>🟡 Đã ngắt kết nối: ${reason}</p>`;
      
      // Auto reconnect sau 3 giây
      setTimeout(() => {
        console.log("🔄 Đang thử kết nối lại...");
        socket.connect();
      }, 3000);
    });

    // Heartbeat acknowledgment
    socket.on('heartbeat_ack', function(data) {
      console.log("💓 Heartbeat ACK received:", data);
    });
    
    socket.on('disconnect', function() {
      console.log("❌ Mất kết nối socket");
      statusDiv.innerHTML = `<h3>📱 Người dùng: ${userPhone}</h3><p>🔴 Mất kết nối socket</p>`;
    });
  </script>
</body>
</html>