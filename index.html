<!DOCTYPE html>
<html>
<head>
  <title>Chat Test</title>
  <style>
    body { margin: 0; padding-bottom: 3rem; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; }
    #form { background: rgba(0, 0, 0, 0.15); padding: 0.25rem; position: fixed; bottom: 0; left: 0; right: 0; display: flex; height: 3rem; box-sizing: border-box; backdrop-filter: blur(10px); }
    #input { border: none; padding: 0 1rem; flex-grow: 1; border-radius: 2rem; margin: 0.25rem; }
    #input:focus { outline: none; }
    #form > button { background: #333; border: none; padding: 0 1rem; margin: 0.25rem; border-radius: 3px; outline: none; color: #fff; }
    #messages { list-style-type: none; margin: 0; padding: 0; }
    #messages > li { padding: 0.5rem 1rem; }
    #messages > li:nth-child(odd) { background: #efefef; }
  </style>
</head>
<body>
  <ul id="messages"></ul>
  <form id="form" action="">
    <input id="input" autocomplete="off" /><button>Gá»­i</button>
  </form>

  <script src="/socket.io/socket.io.js"></script>

  <script>
    // Káº¿t ná»‘i Ä‘áº¿n server
    const socket = io("https://chat.viegrand.site", {
      transports: ['websocket', 'polling'],
      upgrade: true,
      rememberUpgrade: true,
      timeout: 20000
    });
    
    // ÄÄƒng kÃ½ vá»›i sá»‘ Ä‘iá»‡n thoáº¡i 0000000003
    const userPhone = "0000000003";
    
    console.log("ğŸ”— Káº¿t ná»‘i socket vá»›i sá»‘ Ä‘iá»‡n thoáº¡i:", userPhone);
    
    // ÄÄƒng kÃ½ vá»›i server ngay khi script load
    console.log("ğŸ“ ÄÄƒng kÃ½ vá»›i sá»‘ Ä‘iá»‡n thoáº¡i:", userPhone);
    socket.emit('register', userPhone);
    
    // Heartbeat Ä‘á»ƒ giá»¯ káº¿t ná»‘i
    setInterval(() => {
      if (socket.connected) {
        socket.emit('heartbeat', { phone: userPhone, timestamp: Date.now() });
        console.log("ğŸ’“ Heartbeat sent");
      }
    }, 30000); // Gá»­i heartbeat má»—i 30 giÃ¢y
    
    // Láº¥y cÃ¡c element tá»« HTML
    const form = document.getElementById('form');
    const input = document.getElementById('input');
    const messages = document.getElementById('messages');
    
    // Hiá»ƒn thá»‹ thÃ´ng tin káº¿t ná»‘i
    const statusDiv = document.createElement('div');
    statusDiv.innerHTML = `<h3>ğŸ“± NgÆ°á»i dÃ¹ng: ${userPhone}</h3><p>ğŸŸ¢ ÄÃ£ káº¿t ná»‘i socket</p>`;
    statusDiv.style.cssText = 'background: #e8f5e8; padding: 10px; margin: 10px; border-radius: 5px;';
    document.body.insertBefore(statusDiv, messages);

    // Khi form Ä‘Æ°á»£c gá»­i Ä‘i
    form.addEventListener('submit', function(e) {
      e.preventDefault();
      if (input.value) {
        // Gá»­i tin nháº¯n test
        const messageData = {
          sender: userPhone,
          message: input.value,
          timestamp: new Date().toLocaleTimeString()
        };
        
        console.log('ğŸ“¤ Web sending message:', messageData);
        socket.emit('chat message', messageData);
        input.value = '';
      }
    });

    // Láº¯ng nghe tin nháº¯n tá»« app
    socket.on('chat message', function(data) {
      console.log("ğŸ“¨ Nháº­n tin nháº¯n:", data);
      console.log("ğŸ“¨ Kiá»ƒu dá»¯ liá»‡u:", typeof data);
      console.log("ğŸ“¨ Chi tiáº¿t:", JSON.stringify(data, null, 2));
      
      const item = document.createElement('li');
      item.style.cssText = 'background: #f0f8ff; padding: 10px; margin: 5px 0; border-radius: 5px; border-left: 4px solid #007bff;';
      
      if (typeof data === 'string') {
        // Tin nháº¯n Ä‘Æ¡n giáº£n
        item.textContent = `ğŸ“¨ ${data}`;
      } else {
        // Tin nháº¯n cÃ³ cáº¥u trÃºc
        const sender = data.sender || data.senderPhone || 'Unknown';
        const message = data.message || data.messageText || data.message_text || data;
        const time = data.timestamp || data.sent_at || new Date().toLocaleTimeString();
        
        item.innerHTML = `
          <div><strong>ğŸ‘¤ ${sender}</strong></div>
          <div>ğŸ’¬ ${message}</div>
          <div style="font-size: 12px; color: #666;">â° ${time}</div>
        `;
      }
      
      messages.appendChild(item);
      window.scrollTo(0, document.body.scrollHeight);
    });
    
    // Láº¯ng nghe notification
    socket.on('notification', function(data) {
      console.log("ğŸ”” Nháº­n notification:", data);
      
      const item = document.createElement('li');
      item.style.cssText = 'background: #fff3cd; padding: 10px; margin: 5px 0; border-radius: 5px; border-left: 4px solid #ffc107;';
      item.innerHTML = `
        <div><strong>ğŸ”” Notification</strong></div>
        <div>${JSON.stringify(data, null, 2)}</div>
      `;
      
      messages.appendChild(item);
      window.scrollTo(0, document.body.scrollHeight);
    });
    
    // Hiá»ƒn thá»‹ tráº¡ng thÃ¡i káº¿t ná»‘i
    socket.on('connect', function() {
      console.log("âœ… ÄÃ£ káº¿t ná»‘i socket vá»›i ID:", socket.id);
      statusDiv.innerHTML = `<h3>ğŸ“± NgÆ°á»i dÃ¹ng: ${userPhone}</h3><p>ğŸŸ¢ ÄÃ£ káº¿t ná»‘i socket (ID: ${socket.id})</p>`;
      
      // ÄÄƒng kÃ½ láº¡i sau khi káº¿t ná»‘i
      socket.emit('register', userPhone);
      console.log("ğŸ“ ÄÄƒng kÃ½ láº¡i vá»›i sá»‘ Ä‘iá»‡n thoáº¡i:", userPhone);
      
      // Log connection state
      console.log("ğŸ” Socket connected:", socket.connected);
      console.log("ğŸ” Socket id:", socket.id);
    });

    socket.on('connect_error', function(error) {
      console.log("âŒ Lá»—i káº¿t ná»‘i socket:", error);
      statusDiv.innerHTML = `<h3>ğŸ“± NgÆ°á»i dÃ¹ng: ${userPhone}</h3><p>ğŸ”´ Lá»—i káº¿t ná»‘i: ${error.message}</p>`;
    });

    socket.on('disconnect', function(reason) {
      console.log("ğŸ”Œ Ngáº¯t káº¿t ná»‘i socket:", reason);
      statusDiv.innerHTML = `<h3>ğŸ“± NgÆ°á»i dÃ¹ng: ${userPhone}</h3><p>ğŸŸ¡ ÄÃ£ ngáº¯t káº¿t ná»‘i: ${reason}</p>`;
      
      // Auto reconnect sau 3 giÃ¢y
      setTimeout(() => {
        console.log("ğŸ”„ Äang thá»­ káº¿t ná»‘i láº¡i...");
        socket.connect();
      }, 3000);
    });

    // Heartbeat acknowledgment
    socket.on('heartbeat_ack', function(data) {
      console.log("ğŸ’“ Heartbeat ACK received:", data);
    });
    
    socket.on('disconnect', function() {
      console.log("âŒ Máº¥t káº¿t ná»‘i socket");
      statusDiv.innerHTML = `<h3>ğŸ“± NgÆ°á»i dÃ¹ng: ${userPhone}</h3><p>ğŸ”´ Máº¥t káº¿t ná»‘i socket</p>`;
    });
  </script>
</body>
</html>